<?xml version="1.0" encoding="UTF-8"?>
<metamorph xmlns="http://www.culturegraph.org/metamorph"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://www.culturegraph.org/metamorph metamorph.xsd"
           version="1">

    <meta> <!-- Metadata -->
        <name>SISIS-MARC-XML-EXCLUDE-MARKER</name>
    </meta>

    <macros> <!-- Macro definitions --> </macros>

    <rules> <!-- Transformation rules-->

        <!--
           >>> ENRICHMENT <<<
        -->

        <!-- add new "035  .a" based on Catkey map -->
        <entity name="035  " flushWith="record">
			<concat name="a" delimiter="">
				<data source="001">
					<whitelist map="id_map"/>
					<lookup in="id_map" default="" />
					<compose prefix="(IZEXCLUDE)(" postfix=")"/>
				</data>
                <data source="001">
					<whitelist map="id_map"/>
                </data>
			</concat>
		</entity>

		<!-- add new "035  .a" based hbz-ID -->
        <entity name="035  " flushWith="record">
			<concat name="a" delimiter="">
				<data source="035??.a">
					<replace pattern="\(UNION_SEAL\)"  with=""/>
					<whitelist map="id_map"/>
					<lookup in="id_map" default="" />
					<compose prefix="(IZEXCLUDE)(" postfix=")"/>
				</data>
                <data source="035??.a">
					<replace pattern="\(UNION_SEAL\)"  with=""/>
					<whitelist map="id_map"/>
                </data>
			</concat>
		</entity>

		<!-- add new "035  .a" based on 856??.u contains URL with pattern "/ezeit/?" -->
        <entity name="035  " flushWith="record">
			<concat name="a" delimiter="">
				<data source="856??.u">
					<contains string="/ezeit/?" />
					<compose prefix="(IZEXCLUDE)(EZEIT)"/>
				</data>
                <data source="001">
					<contains string="/ezeit/?" />
                </data>
			</concat>
		</entity>

		<!-- TODO Fall 9xx.x als Selektions- und Suchkennzeichen in Alma -> evtl. als neues subfield -->

		<!--
           >>> COPY ALL SOURCES TO TARGET <<<
        -->

        <data name="001" source="001"/>

		<data source="035  .a" name="a" />

		<data source="8564 .q" name="q" />
		<data source="8564 .u" name="u" />
		<data source="8564 .x" name="x" />
		<data source="8564 .3" name="3" />

		<data source="85640.q" name="q" />
		<data source="85640.u" name="u" />
		<data source="85640.x" name="x" />
		<data source="85640.3" name="3" />

		<data source="_else" />

    </rules>

    <maps>
        <filemap name="id_map" files="$[id_map]"/>
    </maps>

</metamorph>
